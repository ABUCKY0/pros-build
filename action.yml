name: Pros Build
description: Automatically build pros projects

inputs:
  repository:
    description: Target repository
    required: false
    default: ${{ github.repository }}
  upload-built-template:
    required: false
    default: true
  project-name:
    required: false
    default: ${{ github.repository }}

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        path: ./pros-project
    - run: cp -r ./pros-project/* ./ # its incredibly silly that I have to do this but otherwise it interferes with other checkouts
      shell: bash

    - name: Check if template
      id: template
      run: |
        template=$(awk -F'=' '/^IS_LIBRARY:=/{print $2}' Makefile)
        echo $template
        echo "template=$template" >> $GITHUB_OUTPUT
      env:
        TEMPLATE: ${{ steps.template.outputs.template }}
      shell: bash

    - name: Get project info
      if: ${{ steps.template.outputs.template == 1 && inputs.upload-built-template == true }}
      id: project-info
      shell: bash
      run: |
        if [ $ACTION = opened ]; then
            # we have to get the head sha directly from the pr api, because github silly ig
            echo "then"
            sha=$(wget -O- --quiet https://api.github.com/repos/LemLib/LemLib/pulls/$PR_NUM | jq -r .head.sha | head -c 6)
        else
            echo "else"
            sha=$(echo "$AFTER" | head -c 6)
        fi

        echo "sha=$sha" >> $GITHUB_OUTPUT
        echo "SHA found: $sha"

        version=$(awk -F'=' '/^VERSION:=/{print $2}' Makefile)
        echo "Version found: $version"
        echo "version=$version" >> "$GITHUB_OUTPUT"

        postfix="$version+$sha"
        echo "postfix=$postfix" >> "$GITHUB_OUTPUT"
        echo "Postfix found: $postfix"

        name="$TEMPLATE_NAME@$postfix"
        echo "name=$name" >> "$GITHUB_OUTPUT"
        echo "Name found: $name"

        # Update version in Makefile
        sed -i "s/^VERSION:=.*\$/VERSION:=$POSTFIX/" Makefile
      env:
        # random info needed in the step
        # TODO: try to figure out if this can be removed
        AFTER: ${{ github.event.after }} # this isn't present for pr opened events
        ACTION: ${{github.event.action}}
        PR_NUM: ${{github.event.number}}
        TEMPLATE_NAME: ${{ github.event.repository.name }}

        # info needed by other steps
        SHA: ${{ steps.project-info.outputs.sha }}
        VER: ${{ steps.project-info.outputs.version }}
        POSTFIX: ${{ steps.project-info.outputs.postfix }}
        NAME: ${{ steps.project-info.outputs.name }}

    #- name: Install ARM Toolchain
    #uses: fiam/arm-none-eabi-gcc@v1
    #with:
    #release: "10-2020-q4"

    #- name: Setup Python
    #uses: actions/setup-python@v2
    #with:
    #python-version: 3.9

    #- name: PIP Installer
    #uses: BSFishy/pip-action@v1
    #with:
    #packages: pros-cli

    #- name: Testing PROS Install
    #run: pros --version
    #shell: bash

    #- name: Checkout
    #uses: actions/checkout@v4
    #with:
    #repository: ${{ inputs.repository }}
    #path: ./pros-project

    #- name: Build PROS Project
    #run: |
    #make clean quick -j
    #shell: bash
